
#Область ОбработчикиСобытий

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	ТекстОшибки = "";
	МассивДокументов = Новый СписокЗначений;
    МассивДокументов.ЗагрузитьЗначения(ПараметрКоманды);
    МассивДокументов = МассивДокументов.ВыгрузитьЗначения();
	ПроверитьВозможностьУстановкиСтатуса(МассивДокументов,ТекстОшибки);
	Если НЕ ТекстОшибки = "" Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстОшибки);
	КонецЕсли; 
	упРаботаСоСтатусамиКлиент.УстановитьСтатусДокументам(МассивДокументов, ПредопределенноеЗначение("Перечисление.упСтатусыЗаявкиНаПеревозкуГруза.КВыполнению"));   
	
КонецПроцедуры

&НаСервере
Процедура ПроверитьВозможностьУстановкиСтатуса(МассивДокументов,ТекстОшибки)
	
	МассивДокументовДляСменыСтатуса = Новый Массив;
	
	ПолучитьДанныеДляПроверки(МассивДокументов, ТекстОшибки);
	
	Для каждого Заявка Из МассивДокументов Цикл
		
		сткВозврата = упЗаданиеНаПеревозку.РазрешеноПеревестиКВыполнению(Заявка.Статус, Заявка.ТребуетсяСогласованиеЗаявкиНаПеревозкуГруза);
	
		Если сткВозврата.Результат Тогда
		    МассивДокументовДляСменыСтатуса.Добавить(Заявка.Ссылка);
		Иначе	
			ТекстОшибки = ТекстОшибки + НСтр("ru = ' Статус не изменен.'") + сткВозврата.ТекстОшибки + Заявка.Ссылка;
		КонецЕсли;
		
	КонецЦикла;	
	
	МассивДокументов = МассивДокументовДляСменыСтатуса;

КонецПроцедуры

Процедура ПолучитьДанныеДляПроверки(МассивДокументов,ТекстОшибки)
	
	ДанныеДокументов = Новый ТаблицаЗначений;
	ДанныеДокументов.Колонки.Добавить("Ссылка");
	ДанныеДокументов.Колонки.Добавить("ТребуетсяСогласованиеЗаявкиНаПеревозкуГруза",Новый ОписаниеТипов("Булево"));
	ДанныеДокументов.Колонки.Добавить("Статус");

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	упЗаявкаНаПеревозкуГруза.Ссылка,
		|	упЗаявкаНаПеревозкуГруза.ВидПеревозки.ТребуетсяСогласованиеЗаявкиНаПеревозкуГруза КАК ТребуетсяСогласованиеЗаявкиНаПеревозкуГруза,
		|	упЗаявкаНаПеревозкуГруза.ВидПеревозки,
		|	ВЫБОР
		|		КОГДА упЗаявкаНаПеревозкуГруза.ПометкаУдаления
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.упСтатусыЗаявкиНаПеревозкуГруза.Отменена)
		|		ИНАЧЕ ЕСТЬNULL(тбСтатусы.Статус, ЗНАЧЕНИЕ(Перечисление.упСтатусыЗаявкиНаПеревозкуГруза.Новая))
		|	КОНЕЦ КАК Статус
		|ИЗ
		|	Документ.упЗаявкаНаПеревозкуГруза КАК упЗаявкаНаПеревозкуГруза
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.упСтатусыЗаявокНаПеревозкуГруза.СрезПоследних КАК тбСтатусы
		|		ПО тбСтатусы.Документ = упЗаявкаНаПеревозкуГруза.Ссылка
		|ГДЕ
		|	упЗаявкаНаПеревозкуГруза.Ссылка В(&МассивДокументов)";
		
	Запрос.УстановитьПараметр("МассивДокументов", МассивДокументов);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Если ВыборкаДетальныеЗаписи.ВидПеревозки = Справочники.упВидыПеревозок.ПустаяСсылка() Тогда
			ТекстОшибки = ТекстОшибки + НСтр("ru = 'Статус не изменен.'") + НСтр("ru = ' Не заполнен вид перевозки у документа '") + ВыборкаДетальныеЗаписи.Ссылка;
			Продолжить;
		КонецЕсли;
		
		НоваяСтрока = ДанныеДокументов.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока,ВыборкаДетальныеЗаписи);

	КонецЦикла;
	
  	МассивДокументов = ДанныеДокументов;
	
КонецПроцедуры // ПолучитьДанныеДляПроверки()
 


#КонецОбласти 

#Область СлужебныеПроцедурыИФункции
// Нет.
#КонецОбласти 


