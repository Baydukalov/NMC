
#Область ОбработчикиСобытий

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	ПараметрыЗаявки = ПараметрыЗаявки(ПараметрКоманды);
	
	Если ПараметрыЗаявки.ПорядокИсполненияЗаявки = ПредопределенноеЗначение("Перечисление.упПорядокИсполненияЗаявок.Рейсом") Тогда
		
		Отказ = Ложь;
		ТекстОшибки = "";
		мсвЗадания = СформироватьЗаданиеНаПеревозкуГрузаНаСервере(ПараметрКоманды, ПараметрыЗаявки.ВидПеревозкиИспользуютсяМультимодальныеПеревозки, ТекстОшибки, Отказ);
		Если Отказ Тогда
			ПоказатьОповещениеПользователя(ТекстОшибки);
			упСервисныеФункцииКлиент.ПоказатьОповещениеПользователяНаше(ТекстОшибки, Истина);
		КонецЕсли;
		Если НЕ Отказ Тогда
			Для каждого текЗадание Из мсвЗадания Цикл
				ОткрытьФорму("Документ.упЗаданиеНаПеревозкуГруза.ФормаОбъекта", Новый Структура("Ключ", текЗадание), ПараметрыВыполненияКоманды.Источник);
			КонецЦикла;
		Иначе
			ПоказатьОповещениеПользователя(НСтр("ru = 'Задание не сформировано.'"),, НСтр("ru = 'Подробности см. в Журнале регистрации.'"), БиблиотекаКартинок.Ошибка32);
		КонецЕсли;
		
	Иначе	
		
		ОписаниеОшибки = Нстр("ru = 'Запрещено формировать задание на перевозку груза по заявке с порядком исполнения ""путевым листом""'");
		упСервисныеФункцииКлиент.ПоказатьОповещениеПользователяНаше(ОписаниеОшибки, Истина);	
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти 

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция СформироватьЗаданиеНаПеревозкуГрузаНаСервере(мсвЗаявкаНаПеревозкуГруза, ИспользуютсяМультимодальныеПеревозки, ТекстОшибки, Отказ)
	
	Если ИспользуютсяМультимодальныеПеревозки Тогда
		Если Документы.упЗаявкаНаПеревозкуГруза.СхемыМультимодальнойПеревозкиЗаявкеПодобраныПравильно(мсвЗаявкаНаПеревозкуГруза) Тогда
			Возврат Документы.упЗаявкаНаПеревозкуГруза.СформироватьЗаданияНаПервозкуГруза(мсвЗаявкаНаПеревозкуГруза, , Ложь, ТекстОшибки, Отказ);
		Иначе
			ТекстОшибки = НСтр(СтрШаблон("ru = 'В документе %1 некорректно подобрана цепь поставки'", мсвЗаявкаНаПеревозкуГруза)); 
			ЗаписьЖурналаРегистрации(НСтр("ru = 'Формирование заданий на перевозку'"), УровеньЖурналаРегистрации.Ошибка, , , ТекстОшибки);
			Отказ = Истина;
		КонецЕсли;
	Иначе	
		Возврат Документы.упЗаявкаНаПеревозкуГруза.СформироватьЗаданияНаПервозкуГруза(мсвЗаявкаНаПеревозкуГруза, , Ложь, ТекстОшибки, Отказ);
	КонецЕсли;
		
КонецФункции

&НаСервере
Функция ПараметрыЗаявки(Ссылка)
	Возврат ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Ссылка, "ПорядокИсполненияЗаявки, ВидПеревозки.ИспользуютсяМультимодальныеПеревозки");	
КонецФункции

#КонецОбласти 