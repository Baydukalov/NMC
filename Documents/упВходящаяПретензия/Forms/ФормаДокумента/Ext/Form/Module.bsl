
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	// СтандартныеПодсистемы.Свойства
	УправлениеСвойствами.ПриЧтенииНаСервере(ЭтотОбъект, ТекущийОбъект);
	// Конец СтандартныеПодсистемы.Свойства
	
	// СтандартныеПодсистемы.ДатыЗапретаИзменения
	ДатыЗапретаИзменения.ОбъектПриЧтенииНаСервере(ЭтотОбъект, ТекущийОбъект);
	// Конец СтандартныеПодсистемы.ДатыЗапретаИзменения

	Если упСервисныеФункции.ЭтоВызовПослеОткрытияФормы(ЭтаФорма) Тогда
		ПриСозданииПриЧтенииНаСервере();
	КонецЕсли; 
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииПриЧтенииНаСервере()
	
	// СтандартныеПодсистемы.ВерсионированиеОбъектов
	ВерсионированиеОбъектов.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов
	
	// Установка статуса.
	Статус = Документы.упВходящаяПретензия.ПолучитьСтатус(Объект.Ссылка);
	ЗаблокироватьЭлементы();
	упРаботаСоСтатусами.УстановитьКнопкиСтатусаВходящейПретензии(Объект.Ссылка, Статус, Элементы);

	// Валютный учет.
	Если ЭтаФорма.ВедетсяВалютныйУчет 
			И ЗначениеЗаполнено(Объект.Соглашение) Тогда
		УстановитьВалютуУчета();
		ЭтаФорма.ВалютаУпрУчета = упСервисныеФункцииВызовСервера.ВалютаУправленческогоУчета();
	КонецЕсли;
		
	// Взаимодействия.
	Взаимодействия.ПодготовитьОповещения(ЭтотОбъект,Параметры,Ложь);

	// Если новый документ
	Если Не ЗначениеЗаполнено(Объект.Ссылка) Тогда 
		Объект.Автор = ПользователиКлиентСервер.ТекущийПользователь();
	КонецЕсли;
		
	Если ЭтаФорма.ИспользуетсяУчетПодразделений
		И НЕ ЗначениеЗаполнено(Объект.Подразделение) Тогда
		Объект.Подразделение = Справочники.упСтруктураПредприятия.ПодразделениеПоУмолчанию(Объект.ДокументОснование, Объект.Автор);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// СтандартныеПодсистемы.Печать
    УправлениеПечатью.ПриСозданииНаСервере(ЭтотОбъект);
    // Конец СтандартныеПодсистемы.Печать
	
	// СтандартныеПодсистемы.Свойства
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("ИмяЭлементаДляРазмещения", "ГруппаДополнительныеРеквизиты");
	УправлениеСвойствами.ПриСозданииНаСервере(ЭтотОбъект, ДополнительныеПараметры);
	// Конец СтандартныеПодсистемы.Свойства
	
	ЭтаФорма.ВедетсяВалютныйУчет			= ПолучитьФункциональнуюОпцию("упВедетсяВалютныйУчет");
	ЭтаФорма.ИспользуетсяУчетПодразделений	= ПолучитьФункциональнуюОпцию("упИспользуетсяУчетПодразделений"); 
	
	ПриСозданииПриЧтенииНаСервере();
	
КонецПроцедуры

// СтандартныеПодсистемы.Печать
&НаКлиенте
Процедура Подключаемый_ВыполнитьКомандуПечати(Команда)
	
    УправлениеПечатьюКлиент.ВыполнитьПодключаемуюКомандуПечати(Команда, ЭтотОбъект, Объект);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ОбновитьКоманды()
    УправлениеПечатьюКлиентСервер.ОбновитьКоманды(ЭтотОбъект, Объект);
КонецПроцедуры
// Конец СтандартныеПодсистемы.Печать

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
		
	Если ЗначениеЗаполнено(НовыйСтатус) Тогда 
		ТекущийОбъект.ДополнительныеСвойства.Вставить("Статус", НовыйСтатус);
	КонецЕсли;
	
	// СтандартныеПодсистемы.Свойства
	УправлениеСвойствами.ПередЗаписьюНаСервере(ЭтотОбъект, ТекущийОбъект);
	// Конец СтандартныеПодсистемы.Свойства

	НовыйСтатус = Неопределено;
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	Статус = Документы.упВходящаяПретензия.ПолучитьСтатус(Объект.Ссылка);
	упРаботаСоСтатусами.УстановитьКнопкиСтатусаВходящейПретензии(Объект.Ссылка, Статус, Элементы);
	ЗаблокироватьЭлементы();

КонецПроцедуры

&НаСервере
Процедура ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	// СтандартныеПодсистемы.Свойства
	УправлениеСвойствами.ОбработкаПроверкиЗаполнения(ЭтотОбъект, Отказ, ПроверяемыеРеквизиты);
	// Конец СтандартныеПодсистемы.Свойства
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	 //СтандартныеПодсистемы.Свойства 
    	Если УправлениеСвойствамиКлиент.ОбрабатыватьОповещения(ЭтотОбъект, ИмяСобытия, Параметр) Тогда
    		ОбновитьЭлементыДополнительныхРеквизитов();
    	КонецЕсли;
	 //Конец СтандартныеПодсистемы.Свойства	

КонецПроцедуры

// СтандартныеПодсистемы.Свойства
 &НаКлиенте
Процедура Подключаемый_РедактироватьСоставСвойств()
	
	УправлениеСвойствамиКлиент.РедактироватьСоставСвойств(ЭтотОбъект);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьЭлементыДополнительныхРеквизитов()
	
	УправлениеСвойствами.ОбновитьЭлементыДополнительныхРеквизитов(ЭтотОбъект);
	
КонецПроцедуры
// Конец СтандартныеПодсистемы.Свойства

&НаКлиенте
Процедура РейсНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(Объект.ЗаявкаНаПеревозкуГруза) Тогда
		
		СтандартнаяОбработка = Ложь;
		Массив = РейсыПоЗаявке();
		ЗначениеОтбора  = Новый Структура("Ссылка", Массив);
		ПараметрыВыбораДокумента = Новый Структура("Отбор", ЗначениеОтбора);
		ОткрытьФорму("Документ.упРейс.ФормаВыбора", ПараметрыВыбораДокумента, Элемент);
		
	КонецЕсли; 
	
КонецПроцедуры

&НаКлиенте
Процедура РейсОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Объект.Рейс = ВыбранноеЗначение;
	
КонецПроцедуры

&НаКлиенте
Процедура РейсАвтоПодбор(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, Ожидание, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(Объект.ЗаявкаНаПеревозкуГруза) И НЕ Текст = "" Тогда
		
		Массив = РейсыПоЗаявке();
		ЗначениеОтбора  = Новый Структура("Ссылка", Массив);
		ПараметрыПолученияДанных = Новый Структура("Отбор", ЗначениеОтбора);
		
	КонецЕсли; 

КонецПроцедуры

&НаКлиенте
Процедура РейсОкончаниеВводаТекста(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(Объект.ЗаявкаНаПеревозкуГруза)  Тогда
		
		Массив = РейсыПоЗаявке();
		ЗначениеОтбора  = Новый Структура("Ссылка", Массив);
		ПараметрыПолученияДанных = Новый Структура("Отбор", ЗначениеОтбора);
		
	КонецЕсли; 

КонецПроцедуры

&НаКлиенте
Процедура ЗаявкаНаПеревозкуГрузаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(Объект.Рейс) Тогда
		
		СтандартнаяОбработка = Ложь;
		Массив = ЗаявкиПоРейсу();
		ЗначениеОтбора  = Новый Структура("Ссылка", Массив);
		ПараметрыВыбораДокумента = Новый Структура("Отбор", ЗначениеОтбора);
		ОткрытьФорму("Документ.упЗаявкаНаПеревозкуГруза.ФормаВыбора", ПараметрыВыбораДокумента, Элемент);
		
	КонецЕсли; 
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаявкаНаПеревозкуГрузаОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Объект.ЗаявкаНаПеревозкуГруза = ВыбранноеЗначение;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаявкаНаПеревозкуГрузаАвтоПодбор(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, Ожидание, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(Объект.Рейс) И НЕ Текст = "" Тогда
		
		Массив = ЗаявкиПоРейсу();
		ЗначениеОтбора  = Новый Структура("Ссылка", Массив);
		ПараметрыПолученияДанных = Новый Структура("Отбор", ЗначениеОтбора);
		
	КонецЕсли; 
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаявкаНаПеревозкуГрузаОкончаниеВводаТекста(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(Объект.Рейс) Тогда
		
		Массив = ЗаявкиПоРейсу();
		ЗначениеОтбора  = Новый Структура("Ссылка", Массив);
		ПараметрыПолученияДанных = Новый Структура("Отбор", ЗначениеОтбора);
		
	КонецЕсли; 
	
КонецПроцедуры

&НаКлиенте
Процедура ДокументОснованиеПриИзменении(Элемент)
	ДокументОснованиеПриИзмененииНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура КомментарийНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
		ОбщегоНазначенияКлиент.ПоказатьФормуРедактированияКомментария(
		Элемент.ТекстРедактирования, 
		ЭтотОбъект, 
		"Объект.Комментарий");
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийТЧРасходы

&НаКлиенте
Процедура РасходыПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	Если ВедетсяВалютныйУчет И НоваяСтрока И Не Копирование Тогда
		ТекущаяСтрока	= Элементы.Расходы.ТекущиеДанные;
		Если ВедетсяВалютныйУчет Тогда
			ТекущаяСтрока.Валюта 		= ВалютаРеглУчета;	
		Иначе
			ТекущаяСтрока.Валюта 		= ПредопределенноеЗначение("Справочник.Валюты.ПустаяСсылка");	
		КонецЕсли;
		ТекущаяСтрока.Количество 	= 1;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура РасходыСтатьяРасходовПриИзменении(Элемент)
	ТекущаяСтрока	= Элементы.Расходы.ТекущиеДанные;
	СтатьяРасходов	= ТекущаяСтрока.СтатьяРасходов;
	Если ЗначениеЗаполнено(СтатьяРасходов) Тогда
		сткРеквизитыСтатьиРасходов = упСервисныеФункцииВызовСервера.ЗначенияРеквизитовОбъекта(СтатьяРасходов, "СтавкаНДС, ПравилаРаспределения");
		ТекущаяСтрока.СтавкаНДС 			= сткРеквизитыСтатьиРасходов.СтавкаНДС;
		ТекущаяСтрока.ПравилоРаспределения 	= сткРеквизитыСтатьиРасходов.ПравилаРаспределения;
		ПересчитатьСтроку(Элемент);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура РасходыКоличествоПриИзменении(Элемент)
	ПересчитатьСтроку(Элемент);
КонецПроцедуры

&НаКлиенте
Процедура РасходыСтавкаНДСПриИзменении(Элемент)
	ПересчитатьСтроку(Элемент);
КонецПроцедуры

&НаКлиенте
Процедура РасходыЦенаПриИзменении(Элемент)
	ПересчитатьСтроку(Элемент);
КонецПроцедуры

&НаКлиенте
Процедура РасходыСуммаПриИзменении(Элемент)
	ПересчитатьСтроку(Элемент);
КонецПроцедуры

&НаКлиенте
Процедура РасходыЗаданиеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;

	Если ЗначениеЗаполнено(Объект.Рейс) Тогда
		
		Массив = ЗаданияПоРейсу();
		ЗначениеОтбора  = Новый Структура("Ссылка", Массив);
		ПараметрыВыбораДокумента = Новый Структура("Отбор", ЗначениеОтбора);
		ОткрытьФорму("Документ.упЗаданиеНаПеревозкуГруза.ФормаВыбора", ПараметрыВыбораДокумента, Элемент);
		
	КонецЕсли; 
	
КонецПроцедуры

&НаКлиенте
Процедура РасходыЗаданиеОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Элементы.Расходы.ТекущиеДанные.Задание = ВыбранноеЗначение;
	
КонецПроцедуры

&НаКлиенте
Процедура РасходыЗаданиеАвтоПодбор(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, Ожидание, СтандартнаяОбработка)
		
	Если ЗначениеЗаполнено(Объект.Рейс) И НЕ Текст = "" Тогда
		
		СтандартнаяОбработка = Ложь;
		Массив = ЗаданияПоРейсу();
		ЗначениеОтбора  = Новый Структура("Ссылка", Массив);
		ПараметрыПолученияДанных = Новый Структура("Отбор", ЗначениеОтбора);
		
	КонецЕсли; 
	
КонецПроцедуры

&НаКлиенте
Процедура РасходыЗаданиеОкончаниеВводаТекста(Элемент, Текст, ДанныеВыбора, ПараметрыПолученияДанных, СтандартнаяОбработка)
		
	Если ЗначениеЗаполнено(Объект.Рейс)  И НЕ Текст = "" Тогда  
		
		СтандартнаяОбработка = Ложь;
		Массив = ЗаданияПоРейсу();
		ЗначениеОтбора  = Новый Структура("Ссылка", Массив);
		ПараметрыПолученияДанных = Новый Структура("Отбор", ЗначениеОтбора);
		
	КонецЕсли; 
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьВалютуУчета()
	ВалютаРеглУчета = упСервисныеФункцииВызовСервера.ВалютаРегламентированногоУчетаОбъекта(Объект);
КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьСтроку(Элемент)
	
	ТекущаяСтрока	= Элементы.Расходы.ТекущиеДанные;
	СтруктураДанные	= Новый Структура("Ссылка", Объект.Ссылка);
	упОбработкаТабличнойЧастиКлиентСервер.ПересчитатьСтрокуРасходовПриИзмененииЗначения(ТекущаяСтрока,ПолучитьИмяПоля(Элемент.Имя),СтруктураДанные);
	
КонецПроцедуры

&НаКлиенте
Функция ПолучитьИмяПоля
	(ИмяПоля)
	Возврат СтрЗаменить(ИмяПоля, "Расходы","");
КонецФункции

&НаСервере 
Функция РейсыПоЗаявке()
	
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	упСтатусыЗаявокНаПеревозкуГруза.Регистратор КАК Рейс
		|ИЗ
		|	РегистрСведений.упСтатусыЗаявокНаПеревозкуГруза КАК упСтатусыЗаявокНаПеревозкуГруза
		|ГДЕ
		|	ТИПЗНАЧЕНИЯ(упСтатусыЗаявокНаПеревозкуГруза.Регистратор) = ТИП(Документ.упРейс)
		|	И упСтатусыЗаявокНаПеревозкуГруза.Документ = &Документ";
		
		Запрос.УстановитьПараметр("Документ", Объект.ЗаявкаНаПеревозкуГруза);
		
		РезультатЗапроса = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Рейс");
				
		Возврат РезультатЗапроса;
		
КонецФункции
	
&НаСервере 
Функция ЗаявкиПоРейсу();
	
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	упРаботыПоРейсу.Задание.ЗаявкаНаПеревозкуГруза КАК Задание
		|ИЗ
		|	РегистрСведений.упРаботыПоРейсу КАК упРаботыПоРейсу
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.упСтатусыЗаданийНаПеревозкуГруза КАК упСтатусыЗаданийНаПеревозкуГруза
		|		ПО упРаботыПоРейсу.Задание = упСтатусыЗаданийНаПеревозкуГруза.Документ
		|ГДЕ
		|	НЕ упСтатусыЗаданийНаПеревозкуГруза.Статус = ЗНАЧЕНИЕ(Перечисление.упСтатусыЗаданияНаПеревозкуГруза.Отменено)
		|	И упРаботыПоРейсу.Рейс = &Рейс";
		
		Запрос.УстановитьПараметр("Рейс", Объект.Рейс);
		
		РезультатЗапроса = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Задание");
				
		Возврат РезультатЗапроса;
		
КонецФункции		

Функция ЗаданияПоРейсу()
	
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	упРейсЗадания.Задание
		|ИЗ
		|	Документ.упРейс.Задания КАК упРейсЗадания
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.упСтатусыЗаданийНаПеревозкуГруза КАК упСтатусыЗаданийНаПеревозкуГруза
		|		ПО упРейсЗадания.Задание = упСтатусыЗаданийНаПеревозкуГруза.Документ
		|ГДЕ
		|	НЕ упСтатусыЗаданийНаПеревозкуГруза.Статус = ЗНАЧЕНИЕ(Перечисление.упСтатусыЗаданияНаПеревозкуГруза.Отменено)
		|	И упРейсЗадания.Ссылка = &Рейс";
		
		Запрос.УстановитьПараметр("Рейс", Объект.Рейс);
		
		РезультатЗапроса = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Задание");
				
		Возврат РезультатЗапроса;

КонецФункции	

#КонецОбласти

#Область ОбработчикиСобытийКоманд

&НаКлиенте
Процедура СтатусОтменен(Команда)
	
	Если Статус <> ПредопределенноеЗначение("Перечисление.упСтатусыВходящейПретензии.Удовлетворена") 
		ИЛИ Статус <> ПредопределенноеЗначение("Перечисление.упСтатусыВходящейПретензии.УдовлетворенаЧастично") 
		ИЛИ Статус <> ПредопределенноеЗначение("Перечисление.упСтатусыВходящейПретензии.Отклонена") Тогда 
		
		ТекстОшибки = "";
		Если УстановитьСтатусОтмененаСервер(ТекстОшибки) Тогда 
			ОповеститьОбИзменении(Объект.Ссылка);
		Иначе
		упСервисныеФункцииКлиент.ПоказатьОповещениеПользователяНаше(ТекстОшибки, Истина);
		КонецЕсли;
	Иначе	
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Претензия отработана, отменить невозможно'"), Объект.Ссылка, "Статус");
	КонецЕсли;
		
КонецПроцедуры

&НаКлиенте
Процедура СтатусВРаботе(Команда)
	
	ТекстОшибки = "";
	Если УстановитьСтатусВРаботеСервер(ТекстОшибки) Тогда 
		ОповеститьОбИзменении(Объект.Ссылка); 
	Иначе
		Если ЗначениеЗаполнено(ТекстОшибки) Тогда
			упСервисныеФункцииКлиент.ПоказатьОповещениеПользователяНаше(ТекстОшибки, Истина);
		КонецЕсли; 
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура СтатусЗавершен(Команда)
	
	Список = Новый СписокЗначений;
	Список.Добавить(1,"Удовлетворить");
	Список.Добавить(2, "Удовлетворить частично");
	Список.Добавить(0	,"Отклонить");
	
	Оповещение = Новый ОписаниеОповещения("ПослеВыбораИзМеню", ЭтотОбъект, Параметры);
	ПоказатьВыборИзМеню(Оповещение, Список, Элементы.СтатусЗавершен);	
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеВыбораИзМеню(ВыбранныйЭлемент, Параметры) Экспорт

	ТекстОшибки = "";
	Если ВыбранныйЭлемент = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	
	Если (ВыбранныйЭлемент.Значение = 0 И УстановитьСтатусОтклоненаСервер(ТекстОшибки)) 
		ИЛИ (ВыбранныйЭлемент.Значение = 1 И УстановитьСтатусУдовлетворенаСервер(ТекстОшибки))
		ИЛИ (ВыбранныйЭлемент.Значение = 2 И УстановитьСтатусУдовлетворенаЧастичноСервер(ТекстОшибки)) Тогда 
			ОповеститьОбИзменении(Объект.Ссылка); 
	Иначе
			Если ЗначениеЗаполнено(ТекстОшибки) Тогда
				упСервисныеФункцииКлиент.ПоказатьОповещениеПользователяНаше(ТекстОшибки, Истина);
			КонецЕсли; 
	КонецЕсли;
		
КонецПроцедуры

#КонецОбласти

#Область УправлениеСтатусом

&НаСервере
Функция УстановитьСтатусВРаботеСервер(ТекстОшибки)
	
	Возврат ИзменитьСтатусПретензии(Перечисления.упСтатусыВходящейПретензии.ВРаботе, ТекстОшибки);
	
КонецФункции

&НаСервере
Функция УстановитьСтатусОтклоненаСервер(ТекстОшибки)
	
	Возврат ИзменитьСтатусПретензии(Перечисления.упСтатусыВходящейПретензии.Отклонена, ТекстОшибки);
	
КонецФункции

&НаСервере
Функция УстановитьСтатусУдовлетворенаСервер(ТекстОшибки)
	
	Возврат ИзменитьСтатусПретензии(Перечисления.упСтатусыВходящейПретензии.Удовлетворена, ТекстОшибки);
	
КонецФункции

&НаСервере
Функция УстановитьСтатусУдовлетворенаЧастичноСервер(ТекстОшибки)
	
	Возврат ИзменитьСтатусПретензии(Перечисления.упСтатусыВходящейПретензии.УдовлетворенаЧастично, ТекстОшибки);
	
КонецФункции

&НаСервере
Функция УстановитьСтатусОтмененаСервер(ТекстОшибки)
	
	Возврат ИзменитьСтатусПретензии(Перечисления.упСтатусыВходящейПретензии.Отменена, ТекстОшибки);
	
КонецФункции

&НаСервере
Функция ИзменитьСтатусПретензии(СтатусПретензии, ТекстОшибки)
	
	НовыйСтатус = СтатусПретензии;
	
	Если ПроверитьЗаполнение() Тогда 
		
		ФлагВозврата = Ложь;
		
		Если (СтатусПретензии = Перечисления.упСтатусыВходящейПретензии.Удовлетворена
			ИЛИ СтатусПретензии = Перечисления.упСтатусыВходящейПретензии.УдовлетворенаЧастично
			ИЛИ СтатусПретензии = Перечисления.упСтатусыВходящейПретензии.Отклонена
			ИЛИ СтатусПретензии = Перечисления.упСтатусыВходящейПретензии.ВРаботе)
			И НЕ ЗначениеЗаполнено(Объект.ОписаниеПретензии) Тогда
			ТекстОшибки = ТекстОшибки + "Не заполнено поле ""Описание претензии""! ";
			Элементы.ОписаниеПретензии.АвтоОтметкаНезаполненного = Истина;
			ФлагВозврата = Истина;
		КонецЕсли;
		
		Если (СтатусПретензии = Перечисления.упСтатусыВходящейПретензии.Удовлетворена
			ИЛИ СтатусПретензии = Перечисления.упСтатусыВходящейПретензии.УдовлетворенаЧастично
			ИЛИ СтатусПретензии = Перечисления.упСтатусыВходящейПретензии.Отклонена)
			И НЕ ЗначениеЗаполнено(Объект.ПричинаПретензии) Тогда
			ТекстОшибки = ТекстОшибки + "Не заполнено поле ""Причина претензии""! ";	
			Элементы.ПричинаПретензии.АвтоОтметкаНезаполненного = Истина;
		    ФлагВозврата = Истина;		
		КонецЕсли;
		
		Если (СтатусПретензии = Перечисления.упСтатусыВходящейПретензии.Удовлетворена
			ИЛИ СтатусПретензии = Перечисления.упСтатусыВходящейПретензии.УдовлетворенаЧастично
			ИЛИ СтатусПретензии = Перечисления.упСтатусыВходящейПретензии.Отклонена)
			И НЕ ЗначениеЗаполнено(Объект.РезультатОбработки) Тогда
			ТекстОшибки = ТекстОшибки + "Не заполнено поле ""Результат обработки""! ";
			Элементы.РезультатОбработки.АвтоОтметкаНезаполненного = Истина;
		    ФлагВозврата = Истина;		
		КонецЕсли;
		
		Если СтатусПретензии = Перечисления.упСтатусыВходящейПретензии.Отклонена
			И ЗначениеЗаполнено(Объект.Расходы) Тогда
			ТекстОшибки = ТекстОшибки + "Табличная часть ""Расходы"" не может быть заполнена при отклонении претензии! ";	
		    ФлагВозврата = Истина;		
		КонецЕсли;
		
		Если ФлагВозврата Тогда
			Возврат Ложь;	
		КонецЕсли; 
		
		Попытка
			Записать();		
		Исключение
			ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			Если Не ЗначениеЗаполнено(ТекстОшибки) Тогда 
				ТекстОшибки = ОписаниеОшибки();
			КонецЕсли;
        	Возврат Ложь;    
		КонецПопытки;
		
		Возврат Истина;
		
	КонецЕсли;
	
	НовыйСтатус = Неопределено;
	
	Возврат Ложь;
	
КонецФункции

Процедура ЗаблокироватьЭлементы()

	Если Не Пользователи.ЭтоПолноправныйПользователь() Тогда 
		Если Статус = Перечисления.упСтатусыВходящейПретензии.Удовлетворена Или Статус = Перечисления.упСтатусыВходящейПретензии.Отменена Тогда
			ТолькоПросмотр = Истина;
			Возврат;
		КонецЕсли;		
	КонецЕсли;	

КонецПроцедуры

&НаСервере
Процедура ДокументОснованиеПриИзмененииНаСервере()
	Если ИспользуетсяУчетПодразделений Тогда
		Подразделение = Справочники.упСтруктураПредприятия.ПодразделениеПоУмолчанию(Объект.ДокументОснование);
		Если ЗначениеЗаполнено(Подразделение)
				И НЕ Подразделение = Объект.Подразделение Тогда
			Объект.Подразделение = Подразделение;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти 
